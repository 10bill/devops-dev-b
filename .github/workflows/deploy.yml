name: Deploy Front & Back to Scaleway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üîë Login to Scaleway Container Registry
        run: |
          echo "${{ secrets.SCALEWAY_ACCESS_KEY }}:${{ secrets.SCALEWAY_SECRET_KEY }}" | docker login rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud -u _ --password-stdin

      # --- BUILD & PUSH BACKEND ---
      - name: üèó Build Backend Docker Image
        run: docker build -t rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/back:latest ./back

      - name: üöÄ Push Backend Image
        run: docker push rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/back:latest

      # --- BUILD & PUSH FRONTEND ---
      - name: üèó Build Frontend Docker Image
        run: docker build -t rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/front:latest ./front

      - name: üöÄ Push Frontend Image
        run: docker push rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/front:latest

      # --- D√âPLOIEMENT SCW ---
      - name: üì¶ Install Scaleway CLI
        run: curl -fsSL https://github.com/scaleway/scaleway-cli/releases/latest/download/scaleway-cli_linux_amd64 -o scw && chmod +x scw && sudo mv scw /usr/local/bin/

      - name: üîë Configure Scaleway CLI
        run: |
          scw config set access-key=${{ secrets.SCALEWAY_ACCESS_KEY }}
          scw config set secret-key=${{ secrets.SCALEWAY_SECRET_KEY }}
          scw config set project-id=${{ secrets.SCALEWAY_PROJECT_ID }}
          scw config set region=${{ secrets.SCALEWAY_REGION }}

      - name: üöÄ Deploy Backend
        run: scw container update ns-bilale-back container-registry-image=rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/back:latest

      - name: üöÄ Deploy Frontend
        run: scw container update ns-bilale-front container-registry-image=rg.${{ secrets.SCALEWAY_REGION }}.scw.cloud/${{ secrets.SCALEWAY_NAMESPACE }}/front:latest
