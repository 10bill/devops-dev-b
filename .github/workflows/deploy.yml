name: Deploy to Scaleway

on:
  push:
    branches:
      - main # ou la branche que vous utilisez

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Scaleway CLI
        run: |
          curl -fsSL https://get.scaleway.com/install | bash
          export PATH=$PATH:/root/.scw/bin
          scw version

      - name: Log in to Scaleway Container Registry
        run: |
          export SCW_SECRET_KEY=${{ secrets.SCW_SECRET_KEY }}
          export SCW_DEFAULT_ORGANIZATION_ID=${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          export SCW_DEFAULT_REGION="fr-par" # ou votre région
          scw container registry login cr-REGION.scaleway-registry.com

      - name: Build and push backend Docker image
        run: |
          docker build -t cr-REGION.scaleway-registry.com/NAMESPACE/backend:latest -f backend/Dockerfile .
          docker push cr-REGION.scaleway-registry.com/NAMESPACE/backend:latest
        env:
          REGION: fr-par # ou votre région
          NAMESPACE: votre-namespace # le namespace de votre registry

      - name: Build and push frontend Docker image
        run: |
          docker build -t cr-REGION.scaleway-registry.com/NAMESPACE/frontend:latest -f frontend/Dockerfile .
          docker push cr-REGION.scaleway-registry.com/NAMESPACE/frontend:latest
        env:
          REGION: fr-par # ou votre région
          NAMESPACE: votre-namespace # le namespace de votre registry

      - name: Deploy to Kubernetes Kapsule (exemple)
        run: |
          # Ajouter les commandes kubectl pour déployer vos images sur Kapsule
          # Ex: kubectl apply -f kubernetes/deployment.yaml
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }} # Si vous utilisez Kapsule

      - name: Run Prisma Migrations
        run: |
          # Ajouter les commandes pour exécuter les migrations Prisma
          # Ex: docker run cr-REGION.scaleway-registry.com/NAMESPACE/backend:latest npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}