name: Deploy to Scaleway

on:
  push:
    branches:
      - main  # ExÃ©cute le pipeline Ã  chaque push sur main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      


      - name: ðŸ”¹ Connexion Ã  Scaleway Container Registry
        run: |
          echo "${{ secrets.SCW_SECRET_KEY }}" | docker login rg.fr-par.scw.cloud -u ${{ secrets.SCW_ACCESS_KEY }} --password-stdin

      

      - name: ðŸ”¹ Build et push du frontend
        run: |
          docker build -t rg.fr-par.scw.cloud/ns-bilale/front:latest ./frontend
          docker push rg.fr-par.scw.cloud/ns-bilale/front:latest

      - name: ðŸ”¹ ExÃ©cuter les migrations Prisma
        run: |
          docker run --rm --env DATABASE_URL=${{ secrets.DATABASE_URL }} rg.fr-par.scw.cloud/ns-bilale/back:latest npx prisma migrate deploy

      - name: ðŸ”¹ DÃ©ployer le backend sur Scaleway
        run: |
          scw container container update ${{ secrets.SCW_BACK_CONTAINER_ID }} image=rg.fr-par.scw.cloud/ns-bilale/back:latest

      - name: ðŸ”¹ DÃ©ployer le frontend sur Scaleway
        run: |
          scw container container update ${{ secrets.SCW_FRONT_CONTAINER_ID }} image=rg.fr-par.scw.cloud/ns-bilale/front:latest
